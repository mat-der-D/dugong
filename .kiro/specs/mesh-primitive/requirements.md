# 要件定義書

## プロジェクト説明 (Input)
Spec2-1 `mesh-primitive`: トポロジエンジン (`PrimitiveMesh`) の実装

参考: docs-dev/spec-ideas/mesh_architecture.md

## はじめに

`PrimitiveMesh` は、CFD フレームワーク `dugong` における3層メッシュアーキテクチャの第1層であり、有限体積法（FVM）メッシュのトポロジエンジンを担う。点・面・セルの基本データを格納し、そこから派生するジオメトリ情報と接続情報を `OnceCell` による遅延計算で提供する。本クレート（`dugong-mesh`）は `crates/mesh/` に実装され、`dugong-types` のみに依存する。

`PrimitiveMesh` は、後続の `PolyMesh`（第2層）および `FvMesh`（第3層）に合成（composition）で取り込まれ、3層全体のトポロジ基盤として機能する。

## 要件

### 要件 1: 基本トポロジデータの格納

**目的:** メッシュ構築者として、点座標・面-頂点接続・所有者・隣接セル情報を `PrimitiveMesh` に格納したい。そうすることで、任意多面体メッシュのトポロジを一意に表現できる。

#### 受け入れ基準

1. `PrimitiveMesh` は、点座標 (`Vec<[f64; 3]>`)・面定義 (`Vec<Vec<usize>>`)・所有者インデックス (`Vec<usize>`)・隣接セルインデックス (`Vec<usize>`)・内部面数 (`usize`)・セル数 (`usize`) を保持しなければならない。
2. 構築時に不変条件（`owner` の長さ == `faces` の長さ、`neighbour` の長さ == `n_internal_faces`、全インデックスが範囲内）が検証される場合、`PrimitiveMesh` は構築を失敗させ `Err` を返さなければならない。
3. `PrimitiveMesh` が構築された後、基本トポロジデータは変更不可（不変）でなければならない。
4. 各面の頂点リスト長に制約はなく、任意多角形（三角形・四角形・多角形）を表現できなければならない。
5. `neighbour` には内部面（`face_index < n_internal_faces`）のみが含まれ、境界面（`face_index >= n_internal_faces`）の隣接セルは存在しない（OpenFOAM 慣行と同等）。

---

### 要件 2: セルジオメトリの遅延計算

**目的:** フレームワーク利用者として、セル中心座標とセル体積を `&self` メソッドで取得したい。そうすることで、`PrimitiveMesh` の基本データから派生するジオメトリ情報を必要になるまでコストをかけずに利用できる。

#### 受け入れ基準

1. `PrimitiveMesh` は `cell_centres(&self) -> &[[f64; 3]]` メソッドを公開しなければならない。
2. `PrimitiveMesh` は `cell_volumes(&self) -> &[f64]` メソッドを公開しなければならない。
3. 各メソッドが初めて呼ばれたとき、`PrimitiveMesh` は点座標・面・所有者から値を計算し内部にキャッシュしなければならない。
4. 同じメソッドを2回目以降に呼んだとき、`PrimitiveMesh` はキャッシュ済みの値を返し再計算を行ってはならない。
5. セル体積の計算結果は、テトラへドロン分解または等価な多面体公式を用いた参照値と許容誤差（相対誤差 1e-10）以内で一致しなければならない。
6. セル中心座標の計算結果は、体積加重平均によるテトラへドロン分解（OpenFOAM と同等の手法）を用いた参照値と許容誤差（相対誤差 1e-10）以内で一致しなければならない。

---

### 要件 3: 面ジオメトリの遅延計算

**目的:** フレームワーク利用者として、面中心座標と面積ベクトルを `&self` メソッドで取得したい。そうすることで、有限体積法の離散化に必要な面ジオメトリを効率的に参照できる。

#### 受け入れ基準

1. `PrimitiveMesh` は `face_centres(&self) -> &[[f64; 3]]` メソッドを公開しなければならない。
2. `PrimitiveMesh` は `face_areas(&self) -> &[[f64; 3]]` メソッドを公開しなければならない（戻り値は面積ベクトル: 法線方向 × 面積スカラー）。
3. 各メソッドが初めて呼ばれたとき、`PrimitiveMesh` は点座標と面定義から値を計算しキャッシュしなければならない。
4. 同じメソッドを2回目以降に呼んだとき、`PrimitiveMesh` はキャッシュ済みの値を返し再計算を行ってはならない。
5. 面積ベクトルは `owner` セルから `neighbour` セルへ向かう向きを正とし、OpenFOAM の慣行と一致しなければならない。
6. 面積ベクトルのノルム（大きさ）は面の実面積と相対誤差 1e-10 以内で一致しなければならない。
7. `n_internal_faces` 個の面の面積ベクトルの総和は（閉じた内部ポリトープであれば）ゼロベクトルと絶対誤差 1e-12 以内で一致しなければならない（保存則検証）。

---

### 要件 4: セル接続情報の遅延計算

**目的:** フレームワーク利用者として、セルが接続するセル・面・点のインデックスリストを `&self` メソッドで取得したい。そうすることで、スペクトルや補間処理においてセル近傍を効率的にトラバースできる。

#### 受け入れ基準

1. `PrimitiveMesh` は `cell_cells(&self) -> &[Vec<usize>]` メソッドを公開しなければならない。
2. `PrimitiveMesh` は `cell_faces(&self) -> &[Vec<usize>]` メソッドを公開しなければならない。
3. `PrimitiveMesh` は `cell_points(&self) -> &[Vec<usize>]` メソッドを公開しなければならない。
4. 各接続情報は初回アクセス時に `owner` および `neighbour` から導出して計算され、以降はキャッシュが返されなければならない。
5. `cell_faces(c)` が返すリストには、セル `c` が所有者または隣接として関与する全面インデックスが含まれなければならない。
6. `cell_cells(c)` が返すリストには、`cell_faces(c)` の各内部面を通じて隣接するセルインデックスが含まれなければならない（境界面には隣接セルなし）。
7. `cell_points(c)` が返すリストには、`cell_faces(c)` に含まれる全面が参照する頂点インデックスが重複なく含まれなければならない。

---

### 要件 5: スレッド安全性

**目的:** 並列フレームワーク利用者として、`PrimitiveMesh` を複数スレッドから安全に参照したい。そうすることで、`rayon` による並列フィールド演算中に共有メッシュへ安全にアクセスできる。

#### 受け入れ基準

1. `PrimitiveMesh` は `Send` および `Sync` を実装しなければならない。
2. 同一の `PrimitiveMesh` への複数スレッドからの並行不変参照（`&PrimitiveMesh`）は安全でなければならない（データ競合なし）。
3. 遅延計算フィールド（`cell_centres` 等）の初期化は、並行アクセス下で重複実行が起きず一度だけ実行されなければならない（`OnceCell` の `Sync` 保証を利用）。
4. `PrimitiveMesh` に `unsafe` コードは含まれてはならない（`OnceCell` 等の安全な抽象を使用）。

---

### 要件 6: 基本トポロジ情報へのアクセサ

**目的:** 上位レイヤー（`PolyMesh`・`FvMesh`）の実装者として、`PrimitiveMesh` の基本データ（点・面・所有者等）を読み取りたい。そうすることで、上位レイヤーが基本トポロジを参照してパッチやアドレッシングを構築できる。

#### 受け入れ基準

1. `PrimitiveMesh` は `points(&self) -> &[[f64; 3]]` メソッドを公開しなければならない。
2. `PrimitiveMesh` は `faces(&self) -> &[Vec<usize>]` メソッドを公開しなければならない。
3. `PrimitiveMesh` は `owner(&self) -> &[usize]` メソッドを公開しなければならない。
4. `PrimitiveMesh` は `neighbour(&self) -> &[usize]` メソッドを公開しなければならない。
5. `PrimitiveMesh` は `n_internal_faces(&self) -> usize` メソッドを公開しなければならない。
6. `PrimitiveMesh` は `n_cells(&self) -> usize` メソッドを公開しなければならない。
7. `PrimitiveMesh` は `n_faces(&self) -> usize` メソッドを公開しなければならない（= `faces().len()`）。
8. `PrimitiveMesh` は `n_points(&self) -> usize` メソッドを公開しなければならない（= `points().len()`）。

---

### 要件 7: エラーハンドリングと不変条件検証

**目的:** メッシュ構築者として、不正なトポロジデータを渡したとき明確なエラーを受け取りたい。そうすることで、メッシュの整合性違反を構築時に早期検出できる。

#### 受け入れ基準

1. `PrimitiveMesh::new(...)` （またはコンストラクタ相当）は `Result<PrimitiveMesh, MeshError>` を返さなければならない。
2. `owner` の長さが `faces` の長さと一致しない場合、`PrimitiveMesh` はエラーを返さなければならない。
3. `neighbour` の長さが `n_internal_faces` と一致しない場合、`PrimitiveMesh` はエラーを返さなければならない。
4. `owner` または `neighbour` に範囲外のセルインデックスが含まれる場合、`PrimitiveMesh` はエラーを返さなければならない。
5. 各面の頂点インデックスに範囲外の点インデックスが含まれる場合、`PrimitiveMesh` はエラーを返さなければならない。
6. エラー型 `MeshError` は `Debug` および `std::error::Error` を実装し、エラーの原因を示す具体的なメッセージを持たなければならない。

---

### 要件 8: テスト可能性と参照実装

**目的:** フレームワーク開発者として、既知のメッシュ形状（立方体・テトラへドロン）を用いてジオメトリ計算の正しさを検証したい。そうすることで、数値計算の正確性をリグレッションテストとして継続的に保証できる。

#### 受け入れ基準

1. `PrimitiveMesh` の単体テストは `crates/mesh/src/` 内の `#[cfg(test)] mod tests` に配置されなければならない。
2. 単一立方体セル（8点・6面）の `PrimitiveMesh` に対して、`cell_volumes` が正しい体積（例: 1.0 m³）を返すことを検証するテストが存在しなければならない。
3. 単一立方体セル（8点・6面）の `PrimitiveMesh` に対して、`cell_centres` が正しい中心座標を返すことを検証するテストが存在しなければならない。
4. 単一立方体セル（8点・6面）の `PrimitiveMesh` に対して、`face_areas` の各面積ベクトルのノルムが正しい面積（例: 1.0 m²）と一致することを検証するテストが存在しなければならない。
5. 不正なトポロジデータ（インデックス範囲外等）で `PrimitiveMesh::new` を呼んだとき `Err` が返ることを検証するテストが存在しなければならない。
6. 浮動小数点の比較はすべて許容誤差（tolerance）を明示しなければならない（絶対誤差 または 相対誤差）。
